<!doctype html>
<meta charset="utf-8">
<style>
    body {

        display: grid;
        grid-template-columns: 1fr 1fr;
        column-gap: 5px;
    }
    .listgrid {
    }
    .formgrid {
    }
    
</style>

<body>

    <title>Star Wars DB lookup:</title>
    <section class="listgrid">
        <h2>People</h2>
        <div>
            <ul data-simply-list="people">
            <template>
                <li>
                    <a  data-simply-field="name"
                        data-simply-transformer="people-link"
                        data-simply-content="fixed" 
                    >
                    <span data-simply-field="name">person</span>
                </a>
                </li>
            </template>
            </ul>
        </div>
    </section>
    <section class="formgrid">
        <h2>Data</h2>
        <div>
            <form data-simply-list="person">
                <template>

                    <h3 data-simply-field="name">person</h3>
                    <span data-simply-field="height">height tall</span> Tall
                    <p data-simply-field="desc">description</p>
                </template>
            </form>
        </div>
    </section>

    <script src="https://cdn.simplyedit.io/1/simply-edit.js" data-simply-storage="none"></script>
    <script src="https://cdn.jsdelivr.net/gh/SimplyEdit/simplyview@2.0.2/dist/simply.everything.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@muze-nl/jsontag@0.9.0/dist/browser.js" type="text/javascript"></script>

    <script>
        <!-- http://localhost:3000/query/people/1/name/ gives C-3PO -->
/*
        let peopleNameQuery = '';
        let namePerson = '';

        peopleNameQuery = 'from(data.people).select({ name : _, height: _, desc: _}).where({name :' + namePerson + '})';

        editor.transformers.people_link = {
            render: function(data) {
                
                var href = '/people/'+(data.href ? data.href : data);
                if (href.indexOf('#people')==-1) {
                     console.log(href);
                     href = '/#people/'+href;
                };
                
                /*
                client.post({body: peopleNameQuery })
                  .then(result => {
                        let peopleX = JSONTag.parse(text);
                        let peopleString = JSON.stringify(peopleX); //parsing the json twice due to a firefox bug
                        let displayPeople = JSON.parse(peopleString);
                        hnpwa.view.person = displayPeople;
                });
                
                return href;
            }
        };
*/
    </script>

    <script type="module" >

    import * as metro from "https://cdn.jsdelivr.net/npm/@muze-nl/metro@0.2.2/src/metro.mjs"

    let url = "http://localhost:3000/query/";
    let queryPeople = 'from(data.people).select({ name : _, height: _, desc: _})';

    //let peopleNameQuery = '';
    //let namePerson = '';

    //peopleNameQuery = 'from(data.people).select({ name : _, height: _, desc: _})'; //.where({name :' + namePerson + '})';

    const client = metro.client(url);

    var hnpwa = simply.app({
        routes: {
             '/:name' : function(params) {
                console.log(params.name);
                let peopleNameQuery = '';
                let namePerson = params.name;
                peopleNameQuery = 'from(data.people).select({ name : _, height: _, desc: _}).where({ name : "' + namePerson + '" })'; 
                
                client.post({body: peopleNameQuery })
                .then(response => response.text())
                .then(text => {
                    console.log("Side panel data requested")
                    console.log(text);
                    let peopleX = JSONTag.parse(text);
                    console.log(peopleX);
                    let peopleString = JSON.stringify(peopleX); //parsing the json twice due to a firefox bug
                    let displayPeople = JSON.parse(peopleString);
                    hnpwa.view.person = displayPeople;
                });
          },
            '/:*': function(params) {
                client.post({body: queryPeople })
                .then(response => response.text())
                .then(text => {
                    console.log("Root data requested")
                    let peopleX = JSONTag.parse(text);
                    let peopleString = JSON.stringify(peopleX); //parsing the json twice due to a firefox bug
                    let displayPeople = JSON.parse(peopleString);
                    hnpwa.view.people = displayPeople;
                });

            }
        },
        view: {
            people: [],
            person: []
        }
    });

    </script>


</body>